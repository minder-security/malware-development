#include <Windows.h>
#include <stdio.h>
#include <tlhelp32.h>


VOID GetProcessList()
{
	HANDLE hSnapshot = NULL;
	DWORD dwProcId = NULL;

	PROCESSENTRY32 Proc = {
		.dwSize = sizeof(PROCESSENTRY32)
	};


	hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
	if (hSnapshot == INVALID_HANDLE_VALUE) {
		printf("[!] ERROR: Creating Snapshot failed with error (%d)\n", GetLastError());
		goto _ErrCleanup;
	}

	if (!Process32First(hSnapshot, &Proc)) {
		printf("[!] ERROR: Enumerating snapshot failed with error: (%d)n", GetLastError());
		goto _ErrCleanup;
	}




	do {
		wprintf(L"%d | %s\n", Proc.th32ProcessID, Proc.szExeFile);


	} while (Process32Next(hSnapshot, &Proc));


	CloseHandle(hSnapshot);


_ErrCleanup:
	if (hSnapshot != NULL)
		CloseHandle(hSnapshot);
	return;

}

BOOL GetProcessHandle(IN DWORD dwProcId, OUT HANDLE *hProcess)
{
	*hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcId);
			
	if (*hProcess == NULL) {
		printf("[!] ERROR: Opening Process [PID: %ul] failed (%d)\n", dwProcId, GetLastError());
		return FALSE;
	}

	return TRUE;
}





VOID DllInjection(IN DWORD *dwPid)
{
	LPWSTR szDllName = NULL;
	LPVOID pLoadLibraryW = NULL;
	LPVOID pRmoteMemoryAddr = NULL;
	HANDLE *hProcess = NULL;
	DWORD dwSize = NULL;


	// Explanation
	puts("---------- STEP 3 - SELECTING A DLL TO INJECT ----------");
	puts("- LoadLibraryW will be loaded and executed inside of the target process, effectively loading the DLL specified.\n");
	

	// Select DLL File

	printf("Enter the path of your DLL: ");
	wscanf("%s", szDllName);


	// Getting Address of LoadLibraryW from Kernel32.dll

	pLoadLibraryW = GetProcAddress(GetModuleHandle(L"kernel32.dll"), "LoadLibraryW");
	if (pLoadLibraryW == NULL) {
		printf("[!] ERROR: Failed to get address of LoadLibraryW from kernel32.dll (%d)\n", GetLastError());
		return;
	}


	// Getting Process Handle

	if (!GetProcessHandle(dwPid, hProcess)) {
		printf("[!] ERROR: Failed to get process handle for pid [%lu] (%d)\n", dwPid, GetLastError());
		return;
	}


	// Allocating Virtual Memory inside the target process

	pRmoteMemoryAddr = VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT|MEM_RESERVE, PAGE_READWRITE);



}












int main()
{
	DWORD dwProcessId = 0;
	DWORD dwTechnique = 0;
	int iOption = 0;




	// Welcome Screen

	puts("========== WELCOME ==========");
	puts("- This is a technical demo showcasing sub-techniques of T1055 Process Injection created by Richard Minder (minder-security.ch).");


	// CHAPTER 1 - Selecting a target Process
	printf(	"\n" \
			"---------- STEP 1 - SELECTING A TARGET PROCESS ----------\n" \
			"\n" \
			"\n" \
			"PID | Process Name\n" \
			"-------------------\n");

	GetProcessList();

	printf("\n\nEnter a valid PID, enter 0 to exit: ");
	scanf("%lu", &dwProcessId);

	if (dwProcessId < 1)
		goto _GoodBye;



	// Chapter 2 - Selecting a Technique

	printf("\n" \
		"---------- STEP 2 - SELECTING AN INJECTION TECHNIQUE ----------\n" \
		"\n" \
		"[1] - Dynamic-link Library Injection (T1055.001)\n" \
		"[2] - Portable Executable Injection (T1055.002)\n" \
		"[3] - Thread Execution Hijacking (T1055.003)\n" \
		"[4] - Asynchronous Procedure Call (T1055.004)\n");

	printf("\nSelect a technique: ");
	scanf("%lu", &dwTechnique);

	swtich(dwTechnique) {
		case 1:
			DllInjection();
			break;
		case 2:
			PeInjection();
			break;
		case 3:
			TeHijacking();
			break;
		case 4:
			ApcHijacking();
			break;
		default:
			goto _GoodBye;
			break;

	}

	return 0;


_GoodBye:
	puts("\n- Goodbye!\n");
	return 0;
}